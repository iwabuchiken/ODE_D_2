<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.0 Transitional//EN">
<html><head><meta http-equiv="Content-Type" content="text/html;charset=iso-8859-1">
<title>collision.cpp Source File</title>
<link href="doxygen.css" rel="stylesheet" type="text/css">
</head><body>
<!-- Generated by Doxygen 1.2.15 -->
<center>
<a href="http://www.alsprogrammingresource.com"><img src="../../../../images/als_programming_resource.jpg" alt="Al's Programming Resource Homepage" align="middle" border=0 width=88 height=31 /></a>&nbsp;<a class="qindex" href="index.html">Main Page</a> &nbsp; <a class="qindex" href="namespaces.html">Namespace List</a> &nbsp; <a class="qindex" href="hierarchy.html">Class Hierarchy</a> &nbsp; <a class="qindex" href="annotated.html">Compound List</a> &nbsp; <a class="qindex" href="files.html">File List</a> &nbsp; <a class="qindex" href="functions.html">Compound Members</a> &nbsp; <a class="qindex" href="globals.html">File Members</a> &nbsp; </center>
<hr><h1>collision.cpp</h1><a href="collision_8cpp.html">Go to the documentation of this file.</a><div class="fragment"><pre>00001 <font class="comment">// Collision detection routines and helper functions </font>
00002 <font class="comment">// (by Alan Baylis 2001, Adapted from the work of Kasper Fauerby - aka Telemachos)</font>
00003 
00004 <font class="preprocessor">#include &lt;math.h&gt;</font>
00005 <font class="preprocessor">#include "<a class="code" href="locmath_8h.html">locmath.h</a>"</font>
00006 <font class="preprocessor">#include "<a class="code" href="collision_8h.html">collision.h</a>"</font>
00007 <font class="preprocessor">#include "<a class="code" href="vector_8h.html">vector.h</a>"</font>
00008 
00009 
<a name="l00010"></a><a class="code" href="collision_8cpp.html#a0">00010</a> <font class="keywordtype">void</font> <a class="code" href="collision_8cpp.html#a0">SetLength</a>(<a class="code" href="classVECTOR.html">VECTOR</a>&amp; v, <font class="keywordtype">float</font> l)
00011 {
00012  <font class="keywordtype">float</font> len = sqrt(v.<a class="code" href="classVECTOR.html#m0">x</a>*v.<a class="code" href="classVECTOR.html#m0">x</a> + v.<a class="code" href="classVECTOR.html#m1">y</a>*v.<a class="code" href="classVECTOR.html#m1">y</a> + v.<a class="code" href="classVECTOR.html#m2">z</a>*v.<a class="code" href="classVECTOR.html#m2">z</a>);    
00013  v.<a class="code" href="classVECTOR.html#m0">x</a> *= l/len;
00014  v.<a class="code" href="classVECTOR.html#m1">y</a> *= l/len;
00015  v.<a class="code" href="classVECTOR.html#m2">z</a> *= l/len;
00016 } 
00017 
<a name="l00018"></a><a class="code" href="collision_8cpp.html#a1">00018</a> <font class="keywordtype">bool</font> <a class="code" href="collision_8cpp.html#a1">IsZeroVector</a>(<a class="code" href="classVECTOR.html">VECTOR</a>&amp; v)
00019 {
00020   <font class="keywordflow">if</font> ((v.<a class="code" href="classVECTOR.html#m0">x</a> == 0.0f) &amp;&amp; (v.<a class="code" href="classVECTOR.html#m1">y</a> == 0.0f) &amp;&amp; (v.<a class="code" href="classVECTOR.html#m2">z</a> == 0.0f))
00021     <font class="keywordflow">return</font> TRUE;
00022   <font class="keywordflow">return</font> FALSE;    
00023 }
00024 
<a name="l00025"></a><a class="code" href="collision_8cpp.html#a2">00025</a> <a class="code" href="classVECTOR.html">VECTOR</a> <a class="code" href="collision_8cpp.html#a2">Wedge</a>(<a class="code" href="classVECTOR.html">VECTOR</a> v1, <a class="code" href="classVECTOR.html">VECTOR</a> v2)
00026 {
00027  <a class="code" href="classVECTOR.html">VECTOR</a> result;
00028  
00029  result.<a class="code" href="classVECTOR.html#m0">x</a> = (v1.<a class="code" href="classVECTOR.html#m1">y</a> * v2.<a class="code" href="classVECTOR.html#m2">z</a>) - (v2.<a class="code" href="classVECTOR.html#m1">y</a> * v1.<a class="code" href="classVECTOR.html#m2">z</a>);
00030  result.<a class="code" href="classVECTOR.html#m1">y</a> = (v1.<a class="code" href="classVECTOR.html#m2">z</a> * v2.<a class="code" href="classVECTOR.html#m0">x</a>) - (v2.<a class="code" href="classVECTOR.html#m2">z</a> * v1.<a class="code" href="classVECTOR.html#m0">x</a>);
00031  result.<a class="code" href="classVECTOR.html#m2">z</a> = (v1.<a class="code" href="classVECTOR.html#m0">x</a> * v2.<a class="code" href="classVECTOR.html#m1">y</a>) - (v2.<a class="code" href="classVECTOR.html#m0">x</a> * v1.<a class="code" href="classVECTOR.html#m1">y</a>);     
00032  
00033  <font class="keywordflow">return</font> (result);    
00034 }
00035 
<a name="l00036"></a><a class="code" href="collision_8cpp.html#a3">00036</a> <font class="keywordtype">float</font> <a class="code" href="collision_8cpp.html#a3">IntersectRayPlane</a>(<a class="code" href="classVECTOR.html">VECTOR</a> rOrigin, <a class="code" href="classVECTOR.html">VECTOR</a> rVector, <a class="code" href="classVECTOR.html">VECTOR</a> pOrigin, <a class="code" href="classVECTOR.html">VECTOR</a> pNormal) 
00037 {
00038   
00039   <font class="keywordtype">float</font> d = - (<a class="code" href="locmath_8cpp.html#a5">DotProduct</a>(pNormal,pOrigin));
00040  
00041   <font class="keywordtype">float</font> numer = <a class="code" href="locmath_8cpp.html#a5">DotProduct</a>(pNormal,rOrigin) + d;
00042   <font class="keywordtype">float</font> denom = <a class="code" href="locmath_8cpp.html#a5">DotProduct</a>(pNormal,rVector);
00043   
00044   <font class="keywordflow">if</font> (denom == 0)  <font class="comment">// normal is orthogonal to vector, cant intersect</font>
00045    <font class="keywordflow">return</font> (-1.0f);
00046    
00047   <font class="keywordflow">return</font> -(numer / denom);    
00048 }
00049 
<a name="l00050"></a><a class="code" href="collision_8cpp.html#a4">00050</a> <font class="keywordtype">float</font> <a class="code" href="collision_8cpp.html#a4">IntersectRaySphere</a>(<a class="code" href="classVECTOR.html">VECTOR</a> rO, <a class="code" href="classVECTOR.html">VECTOR</a> rV, <a class="code" href="classVECTOR.html">VECTOR</a> sO, <font class="keywordtype">float</font> sR) 
00051 {
00052    <a class="code" href="classVECTOR.html">VECTOR</a> TempVect;
00053    TempVect.<a class="code" href="classVECTOR.html#m0">x</a> = sO.<a class="code" href="classVECTOR.html#m0">x</a> - rO.<a class="code" href="classVECTOR.html#m0">x</a>;
00054    TempVect.<a class="code" href="classVECTOR.html#m1">y</a> = sO.<a class="code" href="classVECTOR.html#m1">y</a> - rO.<a class="code" href="classVECTOR.html#m1">y</a>;
00055    TempVect.<a class="code" href="classVECTOR.html#m2">z</a> = sO.<a class="code" href="classVECTOR.html#m2">z</a> - rO.<a class="code" href="classVECTOR.html#m2">z</a>;
00056    <a class="code" href="classVECTOR.html">VECTOR</a> Q = TempVect;
00057    
00058    <font class="keywordtype">float</font> c = <a class="code" href="locmath_8cpp.html#a13">MagnitudeVector</a>(Q);
00059    <font class="keywordtype">float</font> v = <a class="code" href="locmath_8cpp.html#a5">DotProduct</a>(Q,rV);
00060    <font class="keywordtype">float</font> d = sR*sR - (c*c - v*v);
00061 
00062    <font class="comment">// If there was no intersection, return -1</font>
00063    <font class="keywordflow">if</font> (d &lt; 0.0) <font class="keywordflow">return</font> (-1.0f);
00064 
00065    <font class="comment">// Return the distance to the [first] intersecting point</font>
00066    <font class="keywordflow">return</font> (v - sqrt(d));
00067 }
00068 
<a name="l00069"></a><a class="code" href="collision_8cpp.html#a5">00069</a> <font class="keywordtype">bool</font> <a class="code" href="collision_8cpp.html#a5">CheckPointInTriangle</a>(<a class="code" href="classVECTOR.html">VECTOR</a> point, <a class="code" href="classVECTOR.html">VECTOR</a> a, <a class="code" href="classVECTOR.html">VECTOR</a> b, <a class="code" href="classVECTOR.html">VECTOR</a> c) 
00070 {
00071   
00072   <font class="keywordtype">float</font> total_angles = 0.0f;
00073        
00074   <font class="comment">// make the 3 vectors</font>
00075   <a class="code" href="classVECTOR.html">VECTOR</a> TempVect;
00076   TempVect.<a class="code" href="classVECTOR.html#m0">x</a> = point.<a class="code" href="classVECTOR.html#m0">x</a> - a.<a class="code" href="classVECTOR.html#m0">x</a>;
00077   TempVect.<a class="code" href="classVECTOR.html#m1">y</a> = point.<a class="code" href="classVECTOR.html#m1">y</a> - a.<a class="code" href="classVECTOR.html#m1">y</a>;
00078   TempVect.<a class="code" href="classVECTOR.html#m2">z</a> = point.<a class="code" href="classVECTOR.html#m2">z</a> - a.<a class="code" href="classVECTOR.html#m2">z</a>;
00079   <a class="code" href="classVECTOR.html">VECTOR</a> v1 = TempVect;
00080   TempVect.<a class="code" href="classVECTOR.html#m0">x</a> = point.<a class="code" href="classVECTOR.html#m0">x</a> - b.<a class="code" href="classVECTOR.html#m0">x</a>;
00081   TempVect.<a class="code" href="classVECTOR.html#m1">y</a> = point.<a class="code" href="classVECTOR.html#m1">y</a> - b.<a class="code" href="classVECTOR.html#m1">y</a>;
00082   TempVect.<a class="code" href="classVECTOR.html#m2">z</a> = point.<a class="code" href="classVECTOR.html#m2">z</a> - b.<a class="code" href="classVECTOR.html#m2">z</a>;
00083   <a class="code" href="classVECTOR.html">VECTOR</a> v2 = TempVect;
00084   TempVect.<a class="code" href="classVECTOR.html#m0">x</a> = point.<a class="code" href="classVECTOR.html#m0">x</a> - c.<a class="code" href="classVECTOR.html#m0">x</a>;
00085   TempVect.<a class="code" href="classVECTOR.html#m1">y</a> = point.<a class="code" href="classVECTOR.html#m1">y</a> - c.<a class="code" href="classVECTOR.html#m1">y</a>;
00086   TempVect.<a class="code" href="classVECTOR.html#m2">z</a> = point.<a class="code" href="classVECTOR.html#m2">z</a> - c.<a class="code" href="classVECTOR.html#m2">z</a>;
00087   <a class="code" href="classVECTOR.html">VECTOR</a> v3 = TempVect;
00088   
00089   v1 = <a class="code" href="locmath_8cpp.html#a14">GetUnitVector</a>(v1);
00090   v2 = <a class="code" href="locmath_8cpp.html#a14">GetUnitVector</a>(v2);
00091   v3 = <a class="code" href="locmath_8cpp.html#a14">GetUnitVector</a>(v3);
00092   <font class="keywordtype">float</font> Dot1 = <a class="code" href="locmath_8cpp.html#a5">DotProduct</a>(v1,v2);
00093   <font class="keywordflow">if</font> (Dot1 &lt; -1)
00094     Dot1 = -1;
00095   <font class="keywordflow">if</font> (Dot1 &gt; 1)
00096     Dot1 = 1;
00097   total_angles += acos(Dot1);   
00098   <font class="keywordtype">float</font> Dot2 = <a class="code" href="locmath_8cpp.html#a5">DotProduct</a>(v2,v3);
00099   <font class="keywordflow">if</font> (Dot2 &lt; -1)
00100     Dot2 = -1;
00101   <font class="keywordflow">if</font> (Dot2 &gt; 1)
00102     Dot2 = 1;
00103   total_angles += acos(Dot2);
00104   <font class="keywordtype">float</font> Dot3 = <a class="code" href="locmath_8cpp.html#a5">DotProduct</a>(v3,v1);
00105   <font class="keywordflow">if</font> (Dot3 &lt; -1)
00106     Dot3 = -1;
00107   <font class="keywordflow">if</font> (Dot3 &gt; 1)
00108     Dot3 = 1;
00109   total_angles += acos(Dot3); 
00110      
00111   <font class="keywordflow">if</font> (fabs(total_angles-2*pi) &lt;= 0.005)
00112    <font class="keywordflow">return</font> (TRUE);
00113      
00114   <font class="keywordflow">return</font>(FALSE);
00115 }
00116 
<a name="l00117"></a><a class="code" href="collision_8cpp.html#a6">00117</a> <a class="code" href="classVECTOR.html">VECTOR</a> <a class="code" href="collision_8cpp.html#a6">ClosestPointOnLine</a>(<a class="code" href="classVECTOR.html">VECTOR</a>&amp; a, <a class="code" href="classVECTOR.html">VECTOR</a>&amp; b, <a class="code" href="classVECTOR.html">VECTOR</a>&amp; p) 
00118 {
00119    <font class="comment">// Determine t (the length of the vector from ‘a’ to ‘p’)</font>
00120    <a class="code" href="classVECTOR.html">VECTOR</a> TempVect;
00121    TempVect.<a class="code" href="classVECTOR.html#m0">x</a> = p.<a class="code" href="classVECTOR.html#m0">x</a> - a.<a class="code" href="classVECTOR.html#m0">x</a>;
00122    TempVect.<a class="code" href="classVECTOR.html#m1">y</a> = p.<a class="code" href="classVECTOR.html#m1">y</a> - a.<a class="code" href="classVECTOR.html#m1">y</a>;
00123    TempVect.<a class="code" href="classVECTOR.html#m2">z</a> = p.<a class="code" href="classVECTOR.html#m2">z</a> - a.<a class="code" href="classVECTOR.html#m2">z</a>;
00124    <a class="code" href="classVECTOR.html">VECTOR</a> c = TempVect;
00125    TempVect.<a class="code" href="classVECTOR.html#m0">x</a> = b.<a class="code" href="classVECTOR.html#m0">x</a> - a.<a class="code" href="classVECTOR.html#m0">x</a>;
00126    TempVect.<a class="code" href="classVECTOR.html#m1">y</a> = b.<a class="code" href="classVECTOR.html#m1">y</a> - a.<a class="code" href="classVECTOR.html#m1">y</a>;
00127    TempVect.<a class="code" href="classVECTOR.html#m2">z</a> = b.<a class="code" href="classVECTOR.html#m2">z</a> - a.<a class="code" href="classVECTOR.html#m2">z</a>;
00128    <a class="code" href="classVECTOR.html">VECTOR</a> V = TempVect; 
00129       
00130    <font class="keywordtype">float</font> d = <a class="code" href="locmath_8cpp.html#a13">MagnitudeVector</a>(V);
00131       
00132    V = <a class="code" href="locmath_8cpp.html#a14">GetUnitVector</a>(V);  
00133    <font class="keywordtype">double</font> t = <a class="code" href="locmath_8cpp.html#a5">DotProduct</a>(V,c);
00134 
00135    <font class="comment">// Check to see if ‘t’ is beyond the extents of the line segment</font>
00136    <font class="keywordflow">if</font> (t &lt; 0.0f) <font class="keywordflow">return</font> (a);
00137    <font class="keywordflow">if</font> (t &gt; d) <font class="keywordflow">return</font> (b);
00138  
00139    <font class="comment">// Return the point between ‘a’ and ‘b’</font>
00140    <font class="comment">//set length of V to t. V is normalized so this is easy</font>
00141    V.<a class="code" href="classVECTOR.html#m0">x</a> = V.<a class="code" href="classVECTOR.html#m0">x</a> * t;
00142    V.<a class="code" href="classVECTOR.html#m1">y</a> = V.<a class="code" href="classVECTOR.html#m1">y</a> * t;
00143    V.<a class="code" href="classVECTOR.html#m2">z</a> = V.<a class="code" href="classVECTOR.html#m2">z</a> * t;
00144 
00145    TempVect.<a class="code" href="classVECTOR.html#m0">x</a> = a.<a class="code" href="classVECTOR.html#m0">x</a> + V.<a class="code" href="classVECTOR.html#m0">x</a>;           
00146    TempVect.<a class="code" href="classVECTOR.html#m1">y</a> = a.<a class="code" href="classVECTOR.html#m1">y</a> + V.<a class="code" href="classVECTOR.html#m1">y</a>;           
00147    TempVect.<a class="code" href="classVECTOR.html#m2">z</a> = a.<a class="code" href="classVECTOR.html#m2">z</a> + V.<a class="code" href="classVECTOR.html#m2">z</a>;           
00148    <font class="keywordflow">return</font> (TempVect);    
00149 }
00150 
<a name="l00151"></a><a class="code" href="collision_8cpp.html#a7">00151</a> <a class="code" href="classVECTOR.html">VECTOR</a> <a class="code" href="collision_8cpp.html#a7">ClosestPointOnPolygon</a>(<a class="code" href="classVECTOR.html">VECTOR</a> a, <a class="code" href="classVECTOR.html">VECTOR</a> c, <a class="code" href="classVECTOR.html">VECTOR</a> b, <a class="code" href="classVECTOR.html">VECTOR</a> p) 
00152 {
00153     
00154   <a class="code" href="classVECTOR.html">VECTOR</a> Rab = <a class="code" href="collision_8cpp.html#a6">ClosestPointOnLine</a>(a, b, p);
00155   <a class="code" href="classVECTOR.html">VECTOR</a> Rbc = <a class="code" href="collision_8cpp.html#a6">ClosestPointOnLine</a>(b, c, p);
00156   <a class="code" href="classVECTOR.html">VECTOR</a> Rca = <a class="code" href="collision_8cpp.html#a6">ClosestPointOnLine</a>(c, a, p);
00157   
00158   <a class="code" href="classVECTOR.html">VECTOR</a> TempVect;
00159   TempVect.<a class="code" href="classVECTOR.html#m0">x</a> = p.<a class="code" href="classVECTOR.html#m0">x</a> - Rab.<a class="code" href="classVECTOR.html#m0">x</a>;  
00160   TempVect.<a class="code" href="classVECTOR.html#m1">y</a> = p.<a class="code" href="classVECTOR.html#m1">y</a> - Rab.<a class="code" href="classVECTOR.html#m1">y</a>;  
00161   TempVect.<a class="code" href="classVECTOR.html#m2">z</a> = p.<a class="code" href="classVECTOR.html#m2">z</a> - Rab.<a class="code" href="classVECTOR.html#m2">z</a>;  
00162   <font class="keywordtype">float</font> dAB = <a class="code" href="locmath_8cpp.html#a13">MagnitudeVector</a>(TempVect);
00163   TempVect.<a class="code" href="classVECTOR.html#m0">x</a> = p.<a class="code" href="classVECTOR.html#m0">x</a> - Rbc.<a class="code" href="classVECTOR.html#m0">x</a>;  
00164   TempVect.<a class="code" href="classVECTOR.html#m1">y</a> = p.<a class="code" href="classVECTOR.html#m1">y</a> - Rbc.<a class="code" href="classVECTOR.html#m1">y</a>;  
00165   TempVect.<a class="code" href="classVECTOR.html#m2">z</a> = p.<a class="code" href="classVECTOR.html#m2">z</a> - Rbc.<a class="code" href="classVECTOR.html#m2">z</a>;  
00166   <font class="keywordtype">float</font> dBC = <a class="code" href="locmath_8cpp.html#a13">MagnitudeVector</a>(TempVect);
00167   TempVect.<a class="code" href="classVECTOR.html#m0">x</a> = p.<a class="code" href="classVECTOR.html#m0">x</a> - Rca.<a class="code" href="classVECTOR.html#m0">x</a>;  
00168   TempVect.<a class="code" href="classVECTOR.html#m1">y</a> = p.<a class="code" href="classVECTOR.html#m1">y</a> - Rca.<a class="code" href="classVECTOR.html#m1">y</a>;  
00169   TempVect.<a class="code" href="classVECTOR.html#m2">z</a> = p.<a class="code" href="classVECTOR.html#m2">z</a> - Rca.<a class="code" href="classVECTOR.html#m2">z</a>;  
00170   <font class="keywordtype">float</font> dCA = <a class="code" href="locmath_8cpp.html#a13">MagnitudeVector</a>(TempVect);
00171   
00172   <font class="keywordtype">float</font> min = dAB;
00173   <a class="code" href="classVECTOR.html">VECTOR</a> result = Rab;
00174   
00175   <font class="keywordflow">if</font> (dBC &lt; min) 
00176   {
00177     min = dBC;
00178     result = Rbc;
00179   }
00180  
00181   <font class="keywordflow">if</font> (dCA &lt; min)
00182     result = Rca;
00183   
00184     <font class="keywordflow">return</font> (result);    
00185 }
00186 
<a name="l00187"></a><a class="code" href="collision_8cpp.html#a8">00187</a> <font class="keywordtype">bool</font> <a class="code" href="collision_8cpp.html#a8">CheckPointInSphere</a>(<a class="code" href="classVECTOR.html">VECTOR</a> point, <a class="code" href="classVECTOR.html">VECTOR</a> sO, <font class="keywordtype">float</font> sR) 
00188 {
00189   <a class="code" href="classVECTOR.html">VECTOR</a> TempVect;
00190   TempVect.<a class="code" href="classVECTOR.html#m0">x</a> = point.<a class="code" href="classVECTOR.html#m0">x</a> - sO.<a class="code" href="classVECTOR.html#m0">x</a>;
00191   TempVect.<a class="code" href="classVECTOR.html#m1">y</a> = point.<a class="code" href="classVECTOR.html#m1">y</a> - sO.<a class="code" href="classVECTOR.html#m1">y</a>;
00192   TempVect.<a class="code" href="classVECTOR.html#m2">z</a> = point.<a class="code" href="classVECTOR.html#m2">z</a> - sO.<a class="code" href="classVECTOR.html#m2">z</a>;
00193  
00194   <font class="keywordtype">float</font> d = <a class="code" href="locmath_8cpp.html#a13">MagnitudeVector</a>(TempVect);
00195  
00196   <font class="keywordflow">if</font>(d &lt;= sR) 
00197     <font class="keywordflow">return</font> TRUE;
00198   <font class="keywordflow">return</font> FALSE;    
00199 }
00200 
<a name="l00201"></a><a class="code" href="collision_8cpp.html#a9">00201</a> <a class="code" href="classVECTOR.html">VECTOR</a> <a class="code" href="collision_8cpp.html#a9">TangentPlaneNormalOfEllipsoid</a>(<a class="code" href="classVECTOR.html">VECTOR</a> point, <a class="code" href="classVECTOR.html">VECTOR</a> eO, <a class="code" href="classVECTOR.html">VECTOR</a> eR)
00202 {
00203  <a class="code" href="classVECTOR.html">VECTOR</a> TempVect;
00204  TempVect.<a class="code" href="classVECTOR.html#m0">x</a> = point.<a class="code" href="classVECTOR.html#m0">x</a> - eO.<a class="code" href="classVECTOR.html#m0">x</a>;
00205  TempVect.<a class="code" href="classVECTOR.html#m1">y</a> = point.<a class="code" href="classVECTOR.html#m1">y</a> - eO.<a class="code" href="classVECTOR.html#m1">y</a>;
00206  TempVect.<a class="code" href="classVECTOR.html#m2">z</a> = point.<a class="code" href="classVECTOR.html#m2">z</a> - eO.<a class="code" href="classVECTOR.html#m2">z</a>;
00207  <a class="code" href="classVECTOR.html">VECTOR</a> p = TempVect;
00208 
00209  <font class="keywordtype">float</font> a2 = eR.<a class="code" href="classVECTOR.html#m0">x</a> * eR.<a class="code" href="classVECTOR.html#m0">x</a>;
00210  <font class="keywordtype">float</font> b2 = eR.<a class="code" href="classVECTOR.html#m1">y</a> * eR.<a class="code" href="classVECTOR.html#m1">y</a>;
00211  <font class="keywordtype">float</font> c2 = eR.<a class="code" href="classVECTOR.html#m2">z</a> * eR.<a class="code" href="classVECTOR.html#m2">z</a>;
00212 
00213  
00214  <a class="code" href="classVECTOR.html">VECTOR</a> res;
00215  res.<a class="code" href="classVECTOR.html#m0">x</a> = p.<a class="code" href="classVECTOR.html#m0">x</a> / a2;
00216  res.<a class="code" href="classVECTOR.html#m1">y</a> = p.<a class="code" href="classVECTOR.html#m1">y</a> / b2;
00217  res.<a class="code" href="classVECTOR.html#m2">z</a> = p.<a class="code" href="classVECTOR.html#m2">z</a> / c2;
00218 
00219  res = <a class="code" href="locmath_8cpp.html#a14">GetUnitVector</a>(res);    
00220  <font class="keywordflow">return</font> (res);    
00221 }
00222 
<a name="l00223"></a><a class="code" href="collision_8cpp.html#a10">00223</a> <font class="keywordtype">int</font> <a class="code" href="collision_8cpp.html#a10">ClassifyPoint</a>(<a class="code" href="classVECTOR.html">VECTOR</a> point, <a class="code" href="classVECTOR.html">VECTOR</a> pO, <a class="code" href="classVECTOR.html">VECTOR</a> pN)
00224 {
00225  <a class="code" href="classVECTOR.html">VECTOR</a> TempVect;
00226  TempVect.<a class="code" href="classVECTOR.html#m0">x</a> = pO.<a class="code" href="classVECTOR.html#m0">x</a> - point.<a class="code" href="classVECTOR.html#m0">x</a>;
00227  TempVect.<a class="code" href="classVECTOR.html#m1">y</a> = pO.<a class="code" href="classVECTOR.html#m1">y</a> - point.<a class="code" href="classVECTOR.html#m1">y</a>;
00228  TempVect.<a class="code" href="classVECTOR.html#m2">z</a> = pO.<a class="code" href="classVECTOR.html#m2">z</a> - point.<a class="code" href="classVECTOR.html#m2">z</a>;
00229  <a class="code" href="classVECTOR.html">VECTOR</a> dir = TempVect;
00230  <font class="keywordtype">float</font> d = <a class="code" href="locmath_8cpp.html#a5">DotProduct</a>(dir, pN);
00231 
00232  <font class="keywordflow">if</font> (d &lt; -0.001f)
00233    <font class="keywordflow">return</font> 1;
00234  <font class="keywordflow">else</font>
00235    <font class="keywordflow">if</font> (d &gt; 0.001f)
00236      <font class="keywordflow">return</font> -1;
00237    <font class="keywordflow">return</font> 0;
00238 }
00239 
<a name="l00240"></a><a class="code" href="collision_8cpp.html#a11">00240</a> <font class="keywordtype">void</font> <a class="code" href="collision_8cpp.html#a11">CheckForCollision</a>(<a class="code" href="classPOLYGON.html">POLYGON</a>* polygon, <a class="code" href="classVECTOR.html">VECTOR</a>* destination, <a class="code" href="structCollisionPacket.html">CollisionPacket</a>* colPackage)
00241 {
00242     colPackage-&gt;<a class="code" href="structCollisionPacket.html#m5">foundCollision</a> = FALSE;
00243 
00244       <font class="comment">// from package</font>
00245       <a class="code" href="classVECTOR.html">VECTOR</a> eRadius = colPackage-&gt;<a class="code" href="structCollisionPacket.html#m2">eRadius</a>;
00246       <a class="code" href="classVECTOR.html">VECTOR</a> source = colPackage-&gt;<a class="code" href="structCollisionPacket.html#m1">sourcePoint</a>;
00247       <a class="code" href="classVECTOR.html">VECTOR</a> velocity = colPackage-&gt;<a class="code" href="structCollisionPacket.html#m0">velocity</a>;
00248 
00249       <font class="comment">// keep a copy of this as it's needed a few times</font>
00250       <a class="code" href="classVECTOR.html">VECTOR</a> normalizedVelocity = <a class="code" href="locmath_8cpp.html#a14">GetUnitVector</a>(velocity);
00251 
00252       <font class="comment">// intersection data</font>
00253       <a class="code" href="classVECTOR.html">VECTOR</a> sIPoint;    <font class="comment">// sphere intersection point</font>
00254       <a class="code" href="classVECTOR.html">VECTOR</a> pIPoint;    <font class="comment">// plane intersection point</font>
00255       <a class="code" href="classVECTOR.html">VECTOR</a> polyIPoint; <font class="comment">// polygon intersection point</font>
00256 
00257       <font class="keywordtype">float</font> distToPlaneIntersection;
00258       <font class="keywordtype">float</font> distToSphereIntersection;
00259 
00260      <font class="comment">// loop through all the polygons of the cube</font>
00261      <font class="keywordflow">for</font>(<font class="keywordtype">int</font> i = 0; i &lt; 12; i++)
00262       {
00263 
00264           <font class="comment">// Get plane normal</font>
00265           <a class="code" href="classVECTOR.html">VECTOR</a> pOrigin;
00266           pOrigin.<a class="code" href="classVECTOR.html#m0">x</a> = polygon[i].<a class="code" href="classPOLYGON.html#m1">Vertex</a>[0].<a class="code" href="classVERTEX.html#m0">x</a>;        <font class="comment">//Set plane origin</font>
00267           pOrigin.<a class="code" href="classVECTOR.html#m1">y</a> = polygon[i].<a class="code" href="classPOLYGON.html#m1">Vertex</a>[0].<a class="code" href="classVERTEX.html#m1">y</a>;
00268           pOrigin.<a class="code" href="classVECTOR.html#m2">z</a> = polygon[i].<a class="code" href="classPOLYGON.html#m1">Vertex</a>[0].<a class="code" href="classVERTEX.html#m2">z</a>;
00269           <a class="code" href="classVECTOR.html">VECTOR</a> pNormal = polygon[i].<a class="code" href="classPOLYGON.html#a2">GetNormal</a>();
00270 
00271           <font class="comment">// Normalize plane normal</font>
00272           pNormal = <a class="code" href="locmath_8cpp.html#a14">GetUnitVector</a>(pNormal);
00273 
00274           <font class="keywordflow">if</font> (<a class="code" href="locmath_8cpp.html#a5">DotProduct</a>(pNormal, normalizedVelocity) &lt;= 1.0f)
00275           {
00276               <font class="comment">// Calculate sphere intersection point</font>
00277               <a class="code" href="classVECTOR.html">VECTOR</a> eIPoint;
00278               eIPoint.<a class="code" href="classVECTOR.html#m0">x</a> = source.<a class="code" href="classVECTOR.html#m0">x</a> - pNormal.<a class="code" href="classVECTOR.html#m0">x</a>;  <font class="comment">//Source point + inverted plane normal</font>
00279               eIPoint.<a class="code" href="classVECTOR.html#m1">y</a> = source.<a class="code" href="classVECTOR.html#m1">y</a> - pNormal.<a class="code" href="classVECTOR.html#m1">y</a>;
00280               eIPoint.<a class="code" href="classVECTOR.html#m2">z</a> = source.<a class="code" href="classVECTOR.html#m2">z</a> - pNormal.<a class="code" href="classVECTOR.html#m2">z</a>;
00281 
00282               <font class="comment">// shoot ray along the velocity vector</font>
00283               distToPlaneIntersection = <a class="code" href="collision_8cpp.html#a3">IntersectRayPlane</a>(eIPoint, normalizedVelocity, pOrigin, pNormal);
00284 
00285               <font class="comment">// calculate plane intersection point</font>
00286               pIPoint.<a class="code" href="classVECTOR.html#m0">x</a> = eIPoint.<a class="code" href="classVECTOR.html#m0">x</a> + distToPlaneIntersection * normalizedVelocity.<a class="code" href="classVECTOR.html#m0">x</a>;
00287               pIPoint.<a class="code" href="classVECTOR.html#m1">y</a> = eIPoint.<a class="code" href="classVECTOR.html#m1">y</a> + distToPlaneIntersection * normalizedVelocity.<a class="code" href="classVECTOR.html#m1">y</a>;
00288               pIPoint.<a class="code" href="classVECTOR.html#m2">z</a> = eIPoint.<a class="code" href="classVECTOR.html#m2">z</a> + distToPlaneIntersection * normalizedVelocity.<a class="code" href="classVECTOR.html#m2">z</a>;
00289 
00290               <font class="keywordtype">int</font> pClass = <a class="code" href="collision_8cpp.html#a10">ClassifyPoint</a>(eIPoint, pOrigin, pNormal);
00291 
00292               <font class="comment">// find the plane intersection point</font>
00293               <font class="keywordflow">if</font> (pClass == -1)
00294               {               <font class="comment">// plane spans sphere</font>
00295 
00296                 <font class="comment">// find plane intersection point by shooting a ray from the</font>
00297                 <font class="comment">// sphere intersection point along the planes normal.</font>
00298                 distToPlaneIntersection = <a class="code" href="collision_8cpp.html#a3">IntersectRayPlane</a>(eIPoint, pNormal, pOrigin, pNormal);
00299 
00300                 <font class="comment">// calculate plane intersection point</font>
00301                 pIPoint.<a class="code" href="classVECTOR.html#m0">x</a> = eIPoint.<a class="code" href="classVECTOR.html#m0">x</a> + distToPlaneIntersection * pNormal.<a class="code" href="classVECTOR.html#m0">x</a>;
00302                 pIPoint.<a class="code" href="classVECTOR.html#m1">y</a> = eIPoint.<a class="code" href="classVECTOR.html#m1">y</a> + distToPlaneIntersection * pNormal.<a class="code" href="classVECTOR.html#m1">y</a>;
00303                 pIPoint.<a class="code" href="classVECTOR.html#m2">z</a> = eIPoint.<a class="code" href="classVECTOR.html#m2">z</a> + distToPlaneIntersection * pNormal.<a class="code" href="classVECTOR.html#m2">z</a>;
00304               }
00305 
00306               <font class="comment">// find polygon intersection point. By default we assume its equal to the</font>
00307               <font class="comment">// plane intersection point. In that case we already know the distance to it.</font>
00308               polyIPoint = pIPoint;
00309               distToSphereIntersection = distToPlaneIntersection;
00310 
00311               <a class="code" href="classVECTOR.html">VECTOR</a> a, b, c;
00312               a.<a class="code" href="classVECTOR.html#m0">x</a> = polygon[i].Vertex[0].<a class="code" href="classVECTOR.html#m0">x</a>;
00313               a.<a class="code" href="classVECTOR.html#m1">y</a> = polygon[i].Vertex[0].<a class="code" href="classVECTOR.html#m1">y</a>;
00314               a.<a class="code" href="classVECTOR.html#m2">z</a> = polygon[i].Vertex[0].<a class="code" href="classVECTOR.html#m2">z</a>;
00315               b.<a class="code" href="classVECTOR.html#m0">x</a> = polygon[i].Vertex[1].<a class="code" href="classVECTOR.html#m0">x</a>;
00316               b.<a class="code" href="classVECTOR.html#m1">y</a> = polygon[i].Vertex[1].<a class="code" href="classVECTOR.html#m1">y</a>;
00317               b.<a class="code" href="classVECTOR.html#m2">z</a> = polygon[i].Vertex[1].<a class="code" href="classVECTOR.html#m2">z</a>;
00318               c.<a class="code" href="classVECTOR.html#m0">x</a> = polygon[i].Vertex[2].<a class="code" href="classVECTOR.html#m0">x</a>;
00319               c.<a class="code" href="classVECTOR.html#m1">y</a> = polygon[i].Vertex[2].<a class="code" href="classVECTOR.html#m1">y</a>;
00320               c.<a class="code" href="classVECTOR.html#m2">z</a> = polygon[i].Vertex[2].<a class="code" href="classVECTOR.html#m2">z</a>;
00321 
00322               <font class="keywordflow">if</font>(!<a class="code" href="collision_8cpp.html#a5">CheckPointInTriangle</a>(pIPoint, a, b, c))
00323               {
00324                 <font class="comment">// if not in triangle</font>
00325                     polyIPoint = <a class="code" href="collision_8cpp.html#a7">ClosestPointOnPolygon</a>(a, b, c, pIPoint);
00326 
00327                     <a class="code" href="classVECTOR.html">VECTOR</a> invertednormalizedVelocity;
00328                     invertednormalizedVelocity.<a class="code" href="classVECTOR.html#m0">x</a> = -normalizedVelocity.<a class="code" href="classVECTOR.html#m0">x</a>;
00329                     invertednormalizedVelocity.<a class="code" href="classVECTOR.html#m1">y</a> = -normalizedVelocity.<a class="code" href="classVECTOR.html#m1">y</a>;
00330                     invertednormalizedVelocity.<a class="code" href="classVECTOR.html#m2">z</a> = -normalizedVelocity.<a class="code" href="classVECTOR.html#m2">z</a>;
00331                     distToSphereIntersection = <a class="code" href="collision_8cpp.html#a4">IntersectRaySphere</a>(polyIPoint, invertednormalizedVelocity, source, 1.0f);
00332 
00333                     <font class="comment">// we cannot know if the ray will actually hit the sphere so we need this check</font>
00334                     <font class="keywordflow">if</font> (distToSphereIntersection &gt; 0)
00335                     {
00336                           <font class="comment">// calculate true ellipsoid intersection point</font>
00337                           eIPoint.<a class="code" href="classVECTOR.html#m0">x</a> = polyIPoint.<a class="code" href="classVECTOR.html#m0">x</a> + distToSphereIntersection * invertednormalizedVelocity.<a class="code" href="classVECTOR.html#m0">x</a>;
00338                           eIPoint.<a class="code" href="classVECTOR.html#m1">y</a> = polyIPoint.<a class="code" href="classVECTOR.html#m1">y</a> + distToSphereIntersection * invertednormalizedVelocity.<a class="code" href="classVECTOR.html#m1">y</a>;
00339                           eIPoint.<a class="code" href="classVECTOR.html#m2">z</a> = polyIPoint.<a class="code" href="classVECTOR.html#m2">z</a> + distToSphereIntersection * invertednormalizedVelocity.<a class="code" href="classVECTOR.html#m2">z</a>;
00340                     }
00341               }
00342 
00343               <font class="comment">// any chance of hit ?</font>
00344               <font class="keywordflow">if</font> ((distToSphereIntersection &gt; 0) &amp;&amp; (distToSphereIntersection &lt;= <a class="code" href="locmath_8cpp.html#a13">MagnitudeVector</a>(velocity)))
00345               {
00346                       <font class="comment">// if first hit, or closest hit so far</font>
00347                      <font class="keywordflow">if</font> ((colPackage-&gt;<a class="code" href="structCollisionPacket.html#m5">foundCollision</a> == FALSE) || (distToSphereIntersection &lt; colPackage-&gt;<a class="code" href="structCollisionPacket.html#m6">nearestDistance</a>))
00348                      {
00349                            colPackage-&gt;<a class="code" href="structCollisionPacket.html#m6">nearestDistance</a> = distToSphereIntersection;
00350                            colPackage-&gt;<a class="code" href="structCollisionPacket.html#m7">nearestSphereIntersectionPoint</a> = eIPoint;
00351                            colPackage-&gt;<a class="code" href="structCollisionPacket.html#m8">nearestPolygonIntersectionPoint</a> = polyIPoint;
00352                            colPackage-&gt;<a class="code" href="structCollisionPacket.html#m5">foundCollision</a> = TRUE;
00353                      }
00354               }
00355         }
00356     }
00357 
00358     <font class="keywordflow">if</font> (!colPackage-&gt;<a class="code" href="structCollisionPacket.html#m5">foundCollision</a>)
00359         <font class="keywordflow">return</font>;
00360 
00361     <font class="comment">//Collision response</font>
00362 
00363     <font class="comment">// OK, first task is to move close to where we hit something :</font>
00364       <a class="code" href="classVECTOR.html">VECTOR</a> newSourcePoint;
00365 
00366       <font class="comment">// only update if we are not already very close</font>
00367       <font class="keywordflow">if</font> (colPackage-&gt;<a class="code" href="structCollisionPacket.html#m6">nearestDistance</a> &gt;= epsilon)
00368       {
00369 
00370             <a class="code" href="classVECTOR.html">VECTOR</a> V = velocity;
00371               <a class="code" href="collision_8cpp.html#a0">SetLength</a>(V, colPackage-&gt;<a class="code" href="structCollisionPacket.html#m6">nearestDistance</a>-epsilon);
00372             newSourcePoint.<a class="code" href="classVECTOR.html#m0">x</a> = source.<a class="code" href="classVECTOR.html#m0">x</a> + V.<a class="code" href="classVECTOR.html#m0">x</a>;
00373             newSourcePoint.<a class="code" href="classVECTOR.html#m1">y</a> = source.<a class="code" href="classVECTOR.html#m1">y</a> + V.<a class="code" href="classVECTOR.html#m1">y</a>;
00374             newSourcePoint.<a class="code" href="classVECTOR.html#m2">z</a> = source.<a class="code" href="classVECTOR.html#m2">z</a> + V.<a class="code" href="classVECTOR.html#m2">z</a>;
00375       }
00376     <font class="keywordflow">else</font>
00377             newSourcePoint = source;
00378 
00379     <font class="comment">// Determine the sliding plane (we do this now, because we're about to</font>
00380       <font class="comment">// change sourcePoint)</font>
00381       <a class="code" href="classVECTOR.html">VECTOR</a> slidePlaneOrigin = colPackage-&gt;<a class="code" href="structCollisionPacket.html#m8">nearestPolygonIntersectionPoint</a>;
00382       <a class="code" href="classVECTOR.html">VECTOR</a> slidePlaneNormal;
00383       slidePlaneNormal.<a class="code" href="classVECTOR.html#m0">x</a> = newSourcePoint.<a class="code" href="classVECTOR.html#m0">x</a> - colPackage-&gt;<a class="code" href="structCollisionPacket.html#m8">nearestPolygonIntersectionPoint</a>.<a class="code" href="classVECTOR.html#m0">x</a>;
00384       slidePlaneNormal.<a class="code" href="classVECTOR.html#m1">y</a> = newSourcePoint.<a class="code" href="classVECTOR.html#m1">y</a> - colPackage-&gt;<a class="code" href="structCollisionPacket.html#m8">nearestPolygonIntersectionPoint</a>.<a class="code" href="classVECTOR.html#m1">y</a>;
00385       slidePlaneNormal.<a class="code" href="classVECTOR.html#m2">z</a> = newSourcePoint.<a class="code" href="classVECTOR.html#m2">z</a> - colPackage-&gt;<a class="code" href="structCollisionPacket.html#m8">nearestPolygonIntersectionPoint</a>.<a class="code" href="classVECTOR.html#m2">z</a>;
00386         <font class="comment">// We now project the destination point onto the sliding plane</font>
00387       <font class="keywordtype">float</font> l = <a class="code" href="collision_8cpp.html#a3">IntersectRayPlane</a>(*destination, slidePlaneNormal, slidePlaneOrigin, slidePlaneNormal);
00388      <a class="code" href="classVECTOR.html">VECTOR</a> newDestinationPoint;
00389       newDestinationPoint.<a class="code" href="classVECTOR.html#m0">x</a> = destination-&gt;<a class="code" href="classVECTOR.html#m0">x</a> + l * slidePlaneNormal.<a class="code" href="classVECTOR.html#m0">x</a>;
00390       newDestinationPoint.<a class="code" href="classVECTOR.html#m1">y</a> = destination-&gt;<a class="code" href="classVECTOR.html#m1">y</a> + l * slidePlaneNormal.<a class="code" href="classVECTOR.html#m1">y</a>;
00391       newDestinationPoint.<a class="code" href="classVECTOR.html#m2">z</a> = destination-&gt;<a class="code" href="classVECTOR.html#m2">z</a> + l * slidePlaneNormal.<a class="code" href="classVECTOR.html#m2">z</a>;
00392 
00393     <a class="code" href="classVECTOR.html">VECTOR</a> newVelocityVector;
00394       newVelocityVector.<a class="code" href="classVECTOR.html#m0">x</a> = newDestinationPoint.<a class="code" href="classVECTOR.html#m0">x</a> - colPackage-&gt;<a class="code" href="structCollisionPacket.html#m8">nearestPolygonIntersectionPoint</a>.<a class="code" href="classVECTOR.html#m0">x</a>;
00395       newVelocityVector.<a class="code" href="classVECTOR.html#m1">y</a> = newDestinationPoint.<a class="code" href="classVECTOR.html#m1">y</a> - colPackage-&gt;<a class="code" href="structCollisionPacket.html#m8">nearestPolygonIntersectionPoint</a>.<a class="code" href="classVECTOR.html#m1">y</a>;
00396      newVelocityVector.<a class="code" href="classVECTOR.html#m2">z</a> = newDestinationPoint.<a class="code" href="classVECTOR.html#m2">z</a> - colPackage-&gt;<a class="code" href="structCollisionPacket.html#m8">nearestPolygonIntersectionPoint</a>.<a class="code" href="classVECTOR.html#m2">z</a>;
00397 
00398     destination-&gt;<a class="code" href="classVECTOR.html#m0">x</a> = newSourcePoint.<a class="code" href="classVECTOR.html#m0">x</a> + newVelocityVector.<a class="code" href="classVECTOR.html#m0">x</a>;
00399       destination-&gt;<a class="code" href="classVECTOR.html#m1">y</a> = newSourcePoint.<a class="code" href="classVECTOR.html#m1">y</a> + newVelocityVector.<a class="code" href="classVECTOR.html#m1">y</a>;
00400       destination-&gt;<a class="code" href="classVECTOR.html#m2">z</a> = newSourcePoint.<a class="code" href="classVECTOR.html#m2">z</a> + newVelocityVector.<a class="code" href="classVECTOR.html#m2">z</a>;
00401     colPackage-&gt;<a class="code" href="structCollisionPacket.html#m1">sourcePoint</a> = newSourcePoint;
00402     colPackage-&gt;<a class="code" href="structCollisionPacket.html#m0">velocity</a> = newVelocityVector;
00403     colPackage-&gt;<a class="code" href="structCollisionPacket.html#m5">foundCollision</a> = 0;
00404         <a class="code" href="collision_8cpp.html#a11">CheckForCollision</a>(polygon, destination, colPackage);
00405 }
</pre></div><hr><address align="right"><small>Generated on Thu Feb 9 04:21:43 2006 for Basic ODE Example by
<a href="http://www.doxygen.org/index.html">
<img src="doxygen.png" alt="doxygen" align="middle" border=0 
width=110 height=53></a>1.2.15 </small></address>
</body>
</html>
